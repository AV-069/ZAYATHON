package com.sentinel.audit;

import javax.swing.*;
import java.awt.*;
import java.util.Timer;
import java.util.TimerTask;

public class SentinelDashboard extends JFrame {
    private JTextArea logArea;
    private JButton requestBtn;
    
    private int riskScore = 20; 
    private int secondsActive = 0;
    private boolean isMonitoring = false;
    private boolean isSensitiveSession = false;

    public SentinelDashboard() {
        setTitle("Sentinel-Audit | Autonomous Security Proxy");
        setSize(900, 650);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setLayout(new BorderLayout());

        logArea = new JTextArea("--- SENTINEL-AUDIT v8.0: CONTEXTUAL GATEKEEPER ACTIVE ---\n" +
                "[SYSTEM] Ready for Interrogation...\n");
        logArea.setEditable(false);
        logArea.setBackground(new Color(10, 15, 20));
        logArea.setForeground(new Color(0, 255, 180));
        logArea.setFont(new Font("Monospaced", Font.PLAIN, 12));
        add(new JScrollPane(logArea), BorderLayout.CENTER);

        requestBtn = new JButton("Submit Access Request");
        requestBtn.setFont(new Font("Arial", Font.BOLD, 14));
        add(requestBtn, BorderLayout.SOUTH);

        requestBtn.addActionListener(e -> startAIAssessment());
        setVisible(true);
    }

    private void startAIAssessment() {
        String project = JOptionPane.showInputDialog(this, "Project ID (Assigned: PRJ_AUDIT):");
        String tables = JOptionPane.showInputDialog(this, "Tables Requested:");
        String reason = JOptionPane.showInputDialog(this, "Business Justification:");

        if (project == null || tables == null) return;

        // --- STEP 1: CONTEXT PRE-CHECK (The "Anti-Snoop" Logic) ---
        if (!project.equalsIgnoreCase("PRJ_AUDIT")) {
            logArea.append("[DENIED] Project Mismatch: '" + project + "' is not assigned to EMP_001.\n");
            logArea.append("[RESULT] Request Blocked. Risk Score increased.\n");
            JOptionPane.showMessageDialog(this, "ACCESS DENIED: Project ID not recognized.", "Security Block", JOptionPane.ERROR_MESSAGE);
            return; // Exit here so it never reaches the manager
        }

        // --- STEP 2: SENSITIVITY CHECK ---
        if (tables.toLowerCase().contains("payroll") || tables.toLowerCase().contains("salary")) {
            isSensitiveSession = true;
            logArea.append("[!] SENSITIVE DATA DETECTED: Initiating Approval Chain...\n");
            triggerEscalation(tables, reason);
        } else {
            isSensitiveSession = false;
            grantAccess("Standard", tables);
        }
    }

    private void triggerEscalation(String tables, String reason) {
        logArea.append("[STEP 1] Contacting Manager... (Auto-Escalate in 10s)\n");
        
        Timer timer = new Timer();
        timer.schedule(new TimerTask() {
            @Override
            public void run() {
                logArea.append("[TIMEOUT] Manager busy. Failover to Team Lead...\n");
                SwingUtilities.invokeLater(() -> {
                    int choice = JOptionPane.showConfirmDialog(null, "TEAM LEAD OVERRIDE:\nReason: " + reason, "Escalation", JOptionPane.YES_NO_OPTION);
                    if (choice == JOptionPane.YES_OPTION) grantAccess("Elevated", tables);
                });
            }
        }, 10000); 
    }

    private void grantAccess(String level, String tables) {
        logArea.append("[GRANTED] " + level + " access to " + tables + ".\n");
        isMonitoring = true; 
        secondsActive = 0;
        startSilentMonitoring();
        JOptionPane.showMessageDialog(this, "Access Granted. Behavior is being analyzed.");
    }

    private void startSilentMonitoring() {
        Timer monitor = new Timer();
        monitor.schedule(new TimerTask() {
            @Override
            public void run() {
                if (!isMonitoring) { monitor.cancel(); return; }
                secondsActive += 5;

                // Unusual activity detection (No visible timer)
                if (isSensitiveSession && secondsActive > 15) {
                    logArea.append("[ALERT] BEHAVIORAL ANOMALY: Excessive Dwell Time detected.\n");
                    JOptionPane.showMessageDialog(null, "AI ALERT: Suspicious patterns detected. Session flagged.", "SECURITY WARNING", JOptionPane.WARNING_MESSAGE);
                    isMonitoring = false;
                    monitor.cancel();
                }
            }
        }, 1000, 2000);
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(SentinelDashboard::new);
    }
}
